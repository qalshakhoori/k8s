version: 2.1
jobs:
  gcloud:
    docker:
      # - image: google/cloud-sdk
      #   auth:
      #     username: $DOCKER_USERNAME
      #     password: $DOCKER_PASSWORD
      - image: cimg/base:2023.03
    steps:
      - run:
          name: gcloud setup
          command: |
            curl https://sdk.cloud.google.com > install.sh
            bash install.sh --disable-prompts
            source $HOME/google-cloud-sdk/path.bash.inc
            gcloud components update kubectl
            echo "$GCLOUD_SERVICE_KEY" >> service-account.json
            gcloud auth activate-service-account --key-file service-account.json
            gcloud config set project k8s-deployment-382006
            gcloud config set compute/zone europe-west1-b
            gcloud container clusters get-credentials cluster
            echo "$DOCKER_PASSWORD" | docker login -u "$DOCKER_USERNAME" --password-stdin
            docker build -t qassimov/react-test -f ./client/Dockerfile.dev ./client
            docker run -e CI=true qassimov/react-test npm test

workflows:
  build_and_test:
    jobs:
      - gcloud
      # - test
